---
title: "Linear Regression Models"
author: "Herong Wang"
date: "9/28/2022"
output: 
  html_document:
    keep_md: true
---

```{r}
#install.packages("nnet") # for multinomial regression
#install.packages("tidyverse")
library(tidyverse)
library(car)
library(mediation)
library(meta)
library(metasens)
library(nnet)
library(devtools)
#devtools::install_github("BS1125/CMAverse")
library(CMAverse)
library(ggplot2)
if(!require(devtools)) install.packages("devtools")
#devtools::install_github("kassambara/ggpubr")
library(ggpubr)
library(lmtest)
library("viridis")
library(car)

load("analytic_sample_3793.RData")
load("analytic_noother_3679.RData")
load("analytic_bo_3918.RData")


```

## check collinearity between composition of cells

```{r}
cell_perc <- complete %>% 
  select(gran, PMONO, PLYMP)

cor_matrix <- rcorr(as.matrix(cell_perc))
cor_matrix
cor.test(cell_perc$gran, cell_perc$PLYMP) ## percent of granulocytes is highly correlated with                                                              lymphocytes

cor.test(complete$R13SHLT, complete$R13CONDE)

load("included_3915.RData")
cor.test(wave13_included$gran, wave13_included$PLYMP)
```

## Unadjusted model

```{r}
model_unadj <- lm(GRIM_residuals ~ depression, data = complete_bo)

plot(model_unadj)
summary(model_unadj)
confint(model_unadj)
```

## Primary model- age, gender, race/ethnicity, highest degree, marital status

```{r}

model_prim <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = complete_bo)

plot(model_prim)
summary(model_prim)
confint(model_prim)

### interaction models ###
model_prim_sex <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO  + depression*GENDER, data = complete_bo)
summary(model_prim_sex)

model_prim_race <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO  + depression*race_ethnicity, data = complete_bo)
summary(model_prim_race)

complete.racegender <- complete_bo %>% 
  mutate(race_gender = case_when(race_ethnicity == "Non-Hispanic White" & GENDER == "Female" ~ "Non-Hispanic White Female",
                                 race_ethnicity == "NH-Black or Other" & GENDER == "Female" ~ "Non-Hispanic Black or Other Female",
                                 race_ethnicity == "Hispanic" & GENDER == "Female" ~ "Hispanic Female",
                                 race_ethnicity == "Non-Hispanic White" & GENDER == "Male" ~ "Non-Hispanic White Male",
                                 race_ethnicity == "NH-Black or Other" & GENDER == "Male" ~ "Non-Hispanic Black or Other Male",
                                 race_ethnicity == "Hispanic" & GENDER == "Male" ~ "Hispanic Male"))
table(complete_bo$GENDER, complete_bo$race_ethnicity)
table(complete.racegender$race_gender)

complete.racegender$race_gender = as.factor(complete.racegender$race_gender)
complete.racegender$race_gender = relevel(complete.racegender$race_gender, ref = "Non-Hispanic White Male")

model_prim_inter_sex_race <- lm(GRIM_residuals ~ depression + age + race_gender + DEGREE_collapsed + PMARST_collapsed + gran + PMONO + depression*race_gender , data = complete.racegender)
summary(model_prim_inter_sex_race)


```

## Secondary model- including health behaviors

```{r}

model_hlth <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete_bo)

plot(model_hlth)
summary(model_hlth)
confint(model_hlth)

### check interaction ###

model_hlth_inter_race <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + depression*race_ethnicity , data = complete_bo)
summary(model_hlth_inter_race)

model_hlth_inter_sex <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + depression*GENDER , data = complete_bo)
summary(model_hlth_inter_sex)

model_hlth_inter_sex_race <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + depression*GENDER*race_ethnicity , data = complete_bo)
summary(model_hlth_inter_sex_race)


model_hlth_inter_sex_race <- lm(GRIM_residuals ~ depression + age + race_gender + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + depression*race_gender , data = complete.racegender)
summary(model_hlth_inter_sex_race)


## check multicollinearity ##
car::vif(model_hlth)

# Checking which variable is responsible for large change

model_hlth1 <- lm(GRIM_residuals ~ depression + age + GENDER + RACE + DEGREE_collapsed + PMARST_collapsed + R13CONDE, data = complete_bo)
summary(model_hlth1) # coefficient is 0.51

table(complete$R13CONDE)

model_hlth2 <- lm(GRIM_residuals ~ depression + age + GENDER + RACE + DEGREE_collapsed + PMARST_collapsed + R13DRINKD, data = complete_bo)
summary(model_hlth2) # coefficient is 1.21

model_hlth3 <- lm(GRIM_residuals ~ depression + age + GENDER + RACE + DEGREE_collapsed + PMARST_collapsed + smoke, data = complete_bo)
summary(model_hlth3) # coefficient is 1.21

model_hlth4 <- lm(GRIM_residuals ~ depression + age + GENDER + RACE + DEGREE_collapsed + PMARST_collapsed + gran, data = complete_bo)
summary(model_hlth4) # coefficient is 0.92

model_hlth5 <- lm(GRIM_residuals ~ depression + age + GENDER + RACE + DEGREE_collapsed + PMARST_collapsed + PMONO, data = complete_bo) # coefficient is 1.20
summary(model_hlth5)
```


## likelihood test of the model fit between unadjusted & primary & secondary models
### Primary analysis
```{r}
## unadjusted and primary models
lrtest(model_prim, model_unadj)

## primary model and health behavior model (secondary model)
lrtest(model_hlth, model_prim)
```

## Visualizations
```{r}
# GrimAge vs chronological age
complete_bo %>% 
  ggplot(aes(x = age, y= DNAMGRIMAGE))+
  geom_jitter(color = "black", shape = 1, alpha = 0.4, size = 2.5)+
  geom_smooth(color = "black", method = "lm", size = 1.3, se = F)+
  labs(x= "Chronological age (years)", y = "GrimAge age (years)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

complete_bo %>% 
  ggplot(aes(x = age, y = GRIM_residuals))+
  geom_jitter(color = "black", shape = 1, alpha = 0.4, size = 2.5)+
  geom_hline(yintercept=0, size = 1.1)+
  labs(x= "Chronological age (years)", y = "GrimAge residuals (years)")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))


```


## Sensitivity analyses

## Models with CES-D score continuous

```{r}

model_cesd_con <- lm(GRIM_residuals ~ R13CESD, data = complete_bo)

plot(model_cesd_con)
summary(model_cesd_con)
confint(model_cesd_con)

# Primary adjusted model

model_cesd_con2 <- lm(GRIM_residuals ~ R13CESD + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO , data = complete_bo)

plot(model_cesd_con2)
summary(model_cesd_con2)
confint(model_cesd_con2)

# Secondary adjusted model 

model_cesd_con3 <- lm(GRIM_residuals ~ R13CESD + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete_bo)

plot(model_cesd_con3)
summary(model_cesd_con3)
confint(model_cesd_con3)

# add financial situation 
model_pov <- lm(GRIM_residuals ~ R13CESD + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + as.factor(poverty), data = complete_bo)
summary(model_pov)
confint(model_pov)

model_sens <- lm(GRIM_residuals ~ R13CESD + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + R13ACT + as.factor(poverty), data = complete_bo)

plot(model_sens)
summary(model_sens)
confint(model_sens)

```

# Model with any CES-D score greater than 0 as exposed

```{r}

model_cesd_any <- lm(GRIM_residuals ~ any_dep, data = complete)

plot(model_cesd_any)
summary(model_cesd_any)
confint(model_cesd_any)

# Primary adjusted model

model_cesd_any2 <- lm(GRIM_residuals ~ any_dep + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO , data = complete_bo)

plot(model_cesd_any2)
summary(model_cesd_any2)
confint(model_cesd_any2)

# Secondary adjusted model 

model_cesd_any3 <- lm(GRIM_residuals ~ any_dep + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete_bo)

plot(model_cesd_any3)
summary(model_cesd_any3)
confint(model_cesd_any3)

```

# Model with Horvath clock residuals as the outcome variable

```{r}
model_horvath <- lm(HORVATH_residuals ~ depression, data = complete)

plot(model_horvath)
summary(model_horvath)
confint(model_horvath)

# Primary adjusted model

model_horvath2 <- lm(HORVATH_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO , data = complete_bo)

plot(model_horvath2)
summary(model_horvath2)
confint(model_horvath2)

# Secondary adjusted model 

model_horvath3 <- lm(HORVATH_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

plot(model_horvath3)
summary(model_horvath3)
confint(model_horvath3)

```

# Model with LEVINE clock residuals as the outcome variable

```{r}
model_LEVINE <- lm(LEVINE_residuals ~ depression, data = complete)

plot(model_LEVINE)
summary(model_LEVINE)
confint(model_LEVINE)

# Primary adjusted model

model_LEVINE2 <- lm(LEVINE_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO , data = complete_bo)

plot(model_LEVINE2)
summary(model_LEVINE2)
confint(model_LEVINE2)

# Secondary adjusted model 

model_LEVINE3 <- lm(LEVINE_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

plot(model_LEVINE3)
summary(model_LEVINE3)
confint(model_LEVINE3)

```

# Model with MPOA clock residuals as the outcome variable

```{r}
model_MPOA <- lm(MPOA_residuals ~ depression, data = complete)

plot(model_MPOA)
summary(model_MPOA)
confint(model_MPOA)

# Primary adjusted model

model_MPOA2 <- lm(MPOA_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO , data = complete_bo)

plot(model_MPOA2)
summary(model_MPOA2)
confint(model_MPOA2)

# Secondary adjusted model 

model_MPOA3 <- lm(MPOA_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

plot(model_MPOA3)
summary(model_MPOA3)
confint(model_MPOA3)

```

# Model with HANNUM clock residuals as the outcome variable

```{r}
model_HANNUM <- lm(HANNUM_residuals ~ depression, data = complete)

plot(model_HANNUM)
summary(model_HANNUM)
confint(model_HANNUM)

# Primary adjusted model

model_HANNUM2 <- lm(HANNUM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO, data = complete_bo)

plot(model_HANNUM2)
summary(model_HANNUM2)
confint(model_HANNUM2)

# Secondary adjusted model 

model_HANNUM3 <- lm(HANNUM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

plot(model_HANNUM3)
summary(model_HANNUM3)
confint(model_HANNUM3)

```

# Model adding physical activity and childhood poverty

```{r}
model_act_cat <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + R13ACT, data = complete_bo)
summary(model_act_act)
confint(model_act_act)

model_act_cont <- lm(GRIM_residuals ~ R13CESD + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + R13ACT, data = complete_bo)
summary(model_act_cont)
confint(model_act_cont)


model_pov_cat <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + as.factor(poverty), data = complete_bo)
summary(model_pov_cat)
confint(model_pov_cat)

model_pov_cont <- lm(GRIM_residuals ~ R13CESD + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + as.factor(poverty), data = complete_bo)
summary(model_pov_cont)
confint(model_pov_cont)

model_sens_cat <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + R13ACT + as.factor(poverty), data = complete_bo)

plot(model_sens)
summary(model_sens)
confint(model_sens)

## use other physical activity variable ##
model_sens <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + R13VGACTX, data = complete_bo)
summary(model_sens)

## CALCULATE AIC ##
AIC(model_hlth)
AIC(model_act)
AIC(model_pov)
AIC(model_sens)

## ANOVA test for model fit ##
anova(model_hlth, model_pov, test = "F")
anova(model_pov, model_sens, test = "F")
anova(model_hlth, model_sens, test = "F")

## likelihood test for model fit ##
lrtest(model_pov, model_hlth)
lrtest(model_sens, model_pov)
lrtest(model_sens, model_hlth)

```

# check the multicollinearity of childhood finance 
```{r}
vif(model_sens_cat)

```

## race-specific regression

```{r dev='jpeg'}

complete_white = complete_bo %>% 
  filter(race_ethnicity == "Non-Hispanic White")

model_white_unad = lm(GRIM_residuals ~ depression, data = complete_white)
summary(model_white_unad)
confint(model_white_unad)

model_white_prim <- lm(GRIM_residuals ~ depression + age + GENDER  + DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = complete_white)
summary(model_white_prim)
confint(model_white_prim)

model_white_hlth <- lm(GRIM_residuals ~ depression + age + GENDER +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete_white)
summary(model_white_hlth)
confint(model_white_hlth)


complete_black_other = complete_bo %>% 
  filter(race_ethnicity == "NH-Black or Other")

model_black_unad = lm(GRIM_residuals ~ depression, data = complete_black_other)
summary(model_black_unad)
confint(model_black_unad)

model_black_prim <- lm(GRIM_residuals ~ depression + age + GENDER  + DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = complete_black_other)
summary(model_black_prim)
confint(model_black_prim)

model_black_hlth <- lm(GRIM_residuals ~ depression + age + GENDER +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = complete_black_other)
summary(model_black_hlth)
confint(model_black_hlth)

complete_hispanic = complete_bo %>% 
  filter(race_ethnicity == "Hispanic")

model_his_unad = lm(GRIM_residuals ~ depression, data = complete_hispanic)
summary(model_his_unad)
confint(model_his_unad)

model_his_prim <- lm(GRIM_residuals ~ depression + age + GENDER  + DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = complete_hispanic)
summary(model_his_prim)
confint(model_his_prim)

model_his_hlth <- lm(GRIM_residuals ~ depression + age + GENDER +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = complete_hispanic)
summary(model_his_hlth)
confint(model_his_hlth)

library(esc)
library(tidyverse)

# meta analysis ##
#summary(model_white_hlth)
#white_ex_mean <- model_white_hlth$coefficients[1]+model_white_hlth$coefficients[2]
#white_ex_sd <- summary(model_white_hlth)$coefficients[2,2]
#white_ex_n <- 293
#white_unex_mean <- model_white_hlth$coefficients[1]
#white_unex_sd <- summary(model_white_hlth)$coefficients[1,2]
#white_unex_n <- 2246
#group <- "Non-Hispanic White"
#white <- data.frame(group, white_ex_mean,white_ex_sd,white_ex_n,white_unex_mean,white_unex_sd,white_unex_n)

#colnames(white) = c('group', "ex_mean","ex_sd","ex_n","unex_mean","unex_sd","unex_n")

#summary(model_black_hlth)
#black_ex_mean <- model_black_hlth$coefficients[1]+model_black_hlth$coefficients[2]
#black_ex_sd <- summary(model_black_hlth)$coefficients[2,2]
#black_ex_n <- 115
#black_unex_mean <- model_black_hlth$coefficients[1]
#black_unex_sd <- summary(model_black_hlth)$coefficients[1,2]
#black_unex_n <- 518

####table(complete_black$depression)
#group <- "Non-Hispanic Black"
#black <- data.frame(group, black_ex_mean,black_ex_sd,black_ex_n,black_unex_mean,black_unex_sd,black_unex_n)

#colnames(black) = c('group', "ex_mean","ex_sd","ex_n","unex_mean","unex_sd","unex_n")

#other_ex_mean <- model_other_hlth$coefficients[1]+model_other_hlth$coefficients[2]
#other_ex_sd <- summary(model_other_hlth)$coefficients[2,2]
#other_ex_n <- 22
#other_unex_mean <- model_other_hlth$coefficients[1]
#other_unex_sd <- summary(model_other_hlth)$coefficients[1,2]
#other_unex_n <- 92
#group <- "Non-Hispanic Other"
#other <- data.frame(group, other_ex_mean,other_ex_sd,other_ex_n,other_unex_mean,other_unex_sd,other_unex_n)
#colnames(other) = c('group', "ex_mean","ex_sd","ex_n","unex_mean","unex_sd","unex_n")

#his_ex_mean <- model_his_hlth$coefficients[1]+model_his_hlth$coefficients[2]
#his_ex_sd <- summary(model_his_hlth)$coefficients[2,2]
#his_ex_n <- 114
#his_unex_mean <- model_his_hlth$coefficients[1]
#his_unex_sd <- summary(model_his_hlth)$coefficients[1,2]
#his_unex_n <- 393
#group <- "Hispanic"
# <- data.frame(group, his_ex_mean,his_ex_sd,his_ex_n,his_unex_mean,his_unex_sd,his_unex_n)
#colnames(hispanic) = c('group', "ex_mean","ex_sd","ex_n","unex_mean","unex_sd","unex_n")

#table(complete_hispanic$depression)

#meta <- rbind(white, black, other, hispanic)
#rownames(meta) <- c("1", "2", "3", "4") ####


library(meta)
library(metasens)

#meta_race =  metacont(ex_n, ex_mean, ex_sd, 
              #unex_n, unex_mean, unex_sd,
              #comb.fixed = T, comb.random = T, studlab = group,
              #data = meta, sm = "SMD") 
#meta_race

#forest_race = forest(meta_race, print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = F,
       #leftcols = c("studlab",  "effect.ci"), leftlabs = c("Strata", "Effect Estimate (95% CI)"),
       #rightcols = c("w.fixed", "w.random"), xlim = c(-1,1))


#### do not use metacont() here
######## metacont() is used in raw data instead of pre-calculated effect size
##################### for pre-calculated effect size, we can use metagen()


############### Health behavior models ###############
group = "Non-Hispanic White"
effect.size = model_white_hlth$coefficients[2]
effect.size.se <- summary(model_white_hlth)$coefficients[2,2]
white <- data.frame(group, effect.size, effect.size.se)
colnames(white) = c('group', "effect.size", "effect.size.sd")

group = "Non-Hispanic Black or Other"
effect.size = model_black_hlth$coefficients[2]
effect.size.se <- summary(model_black_hlth)$coefficients[2,2]
black <- data.frame(group, effect.size, effect.size.se)
colnames(black) = c('group', "effect.size", "effect.size.sd")

#group = "Other"
#effect.size = model_other_hlth$coefficients[2]
#effect.size.se <- summary(model_other_hlth)$coefficients[2,2]
#other <- data.frame(group, effect.size, effect.size.se)
#colnames(other) = c('group', "effect.size", "effect.size.sd")

group = "Hispanic"
effect.size = model_his_hlth$coefficients[2]
effect.size.se <- summary(model_his_hlth)$coefficients[2,2]
his <- data.frame(group, effect.size, effect.size.se)
colnames(his) = c('group', "effect.size", "effect.size.sd")

meta_race <- rbind(white, black, his)
rownames(meta_race) <- c("1", "2", "3")

meta.race <- metagen(TE = effect.size,
                 seTE = effect.size.sd,
                 studlab = group,
                 data = meta_race,
                 sm = "MD",
                 fixed = T,
                 random = F,
                 method.tau = "REML",
                 hakn = TRUE)

summary(meta.race)

forest(meta.race,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = F,
                     comb.random=F, comb.fixed = F, common = F, leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient [95% CI] "), xlim = c(-2,2),smlab = "")


tiff(filename = "C:/Users/herongw/Desktop/Kelly_RA/Projects/depressive_DNAm_HRS/forest_race_hlth.tif", res = 500, height = 1500, width = 4500)
forest(meta.race,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = T,
                     comb.random=FALSE,leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient for high depressive 
            symptoms (CES-D>=4)[95% CI] "), rightcols = c("w.fixed"), xlim = c(-2,2),smlab = "Mean difference in 
GrimAge acceleration")
dev.off()
  ########### primary models #####################

group = "Non-Hispanic White"
effect.size = model_white_prim$coefficients[2]
effect.size.se <- summary(model_white_prim)$coefficients[2,2]
white <- data.frame(group, effect.size, effect.size.se)
colnames(white) = c('group', "effect.size", "effect.size.sd")

group = "Non-Hispanic Black or Other"
effect.size = model_black_prim$coefficients[2]
effect.size.se <- summary(model_black_prim)$coefficients[2,2]
black <- data.frame(group, effect.size, effect.size.se)
colnames(black) = c('group', "effect.size", "effect.size.sd")

#group = "Other"
#effect.size = model_other_hlth$coefficients[2]
#effect.size.se <- summary(model_other_hlth)$coefficients[2,2]
#other <- data.frame(group, effect.size, effect.size.se)
#colnames(other) = c('group', "effect.size", "effect.size.sd")

group = "Hispanic"
effect.size = model_his_prim$coefficients[2]
effect.size.se <- summary(model_his_prim)$coefficients[2,2]
his <- data.frame(group, effect.size, effect.size.se)
colnames(his) = c('group', "effect.size", "effect.size.sd")

meta_race <- rbind(white, black, his)
rownames(meta_race) <- c("1", "2", "3")

meta.race <- metagen(TE = effect.size,
                 seTE = effect.size.sd,
                 studlab = group,
                 data = meta_race,
                 sm = "MD",
                 fixed = T,
                 random = F,
                 method.tau = "REML",
                 hakn = TRUE)

summary(meta.race)

forest_race.prim = forest(meta.race,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = T,
                  comb.random=FALSE,leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient for high depressive 
            symptoms (CES-D>=4)[95% CI] "), rightcols = c("w.fixed"), xlim = c(-2,2), smlab = "Mean difference in 
GrimAge acceleration")

tiff(filename = "C:/Users/herongw/Desktop/Kelly_RA/Projects/depressive_DNAm_HRS/forest_race_prim.tif", res = 500, height = 1500, width = 4500)
forest(meta.race,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = T,
                  comb.random=FALSE,leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient for high depressive 
            symptoms (CES-D>=4)[95% CI] "), rightcols = c("w.fixed"), xlim = c(-2,2), smlab = "Mean difference in 
GrimAge acceleration")
dev.off()

```


## sex specific regression

```{r}
complete_male <- complete_bo %>% 
  filter(GENDER == "Male")

model_male_unad = lm(GRIM_residuals ~ depression, data = complete_male)
summary(model_male_unad)
confint(model_male_unad)

model_male_prim <- lm(GRIM_residuals ~ depression + age + race_ethnicity  + DEGREE_collapsed + PMARST_collapsed + gran + PMONO, data = complete_male)
summary(model_male_prim)
confint(model_male_prim)

model_male_hlth <- lm(GRIM_residuals ~ depression + age + race_ethnicity +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = complete_male)
summary(model_male_hlth)
confint(model_male_hlth)

complete_female <- complete_bo %>% 
  filter(GENDER == "Female")

model_female_unad = lm(GRIM_residuals ~ depression, data = complete_female)
summary(model_female_unad)
confint(model_female_unad)

model_female_prim <- lm(GRIM_residuals ~ depression + age + race_ethnicity  + DEGREE_collapsed + PMARST_collapsed + gran + PMONO, data = complete_female)
summary(model_female_prim)
confint(model_female_prim)

model_female_hlth <- lm(GRIM_residuals ~ depression + age + race_ethnicity +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = complete_female)
summary(model_female_hlth)
confint(model_female_hlth)


## meta analysis ##

#### do not use metacont() here
######## metacont() is used in raw data instead of pre-calculated effect size
##################### for pre-calculated effect size, we can use metagen()

############## health behaviroal models ###############
group = "Male"
effect.size = model_male_hlth$coefficients[2]
effect.size.se <- summary(model_male_hlth)$coefficients[2,2]
male <- data.frame(group, effect.size, effect.size.se)
colnames(male) = c('group', "effect.size", "effect.size.sd")

group = "Female"
effect.size = model_female_hlth$coefficients[2]
effect.size.se <- summary(model_female_hlth)$coefficients[2,2]
female <- data.frame(group, effect.size, effect.size.se)
colnames(female) = c('group', "effect.size", "effect.size.sd")

meta_sex <- rbind(male, female,white, black, his)
rownames(meta_sex) <- c("1", "2", "3", "4", "5")

meta.sex <- metagen(TE = effect.size,
                 seTE = effect.size.sd,
                 studlab = group,
                 data = meta_sex,
                 sm = "MD",
                 fixed = T,
                 random = F,
                 method.tau = "REML",
                 hakn = TRUE)

summary(meta.sex)

forest_sex.hlth = forest(meta.sex,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = F,common = F, 
       leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient[95% CI] "),
       rightcols = c("w.fixed"), xlim = c(-2,2),smlab = "")

tiff(filename = "C:/Users/herongw/Desktop/Kelly_RA/Projects/depressive_DNAm_HRS/forest_sex_hlth.tif", res = 500, height = 1500, width = 4500)
forest(meta.sex,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = T, 
       leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient for high depressive 
            symptoms (CES-D>=4)[95% CI] "),
       rightcols = c("w.fixed"), xlim = c(-2,2),smlab = "Mean difference in 
GrimAge acceleration")
dev.off()


############## primary models #########################
group = "Male"
effect.size = model_male_prim$coefficients[2]
effect.size.se <- summary(model_male_prim)$coefficients[2,2]
male <- data.frame(group, effect.size, effect.size.se)
colnames(male) = c('group', "effect.size", "effect.size.sd")

group = "Female"
effect.size = model_female_prim$coefficients[2]
effect.size.se <- summary(model_female_prim)$coefficients[2,2]
female <- data.frame(group, effect.size, effect.size.se)
colnames(female) = c('group', "effect.size", "effect.size.sd")

meta_sex <- rbind(male, female, white, black, his)
rownames(meta_sex) <- c("1", "2", "3", "4", "5")

meta.sex <- metagen(TE = effect.size,
                 seTE = effect.size.sd,
                 studlab = group,
                 data = meta_sex,
                 sm = "MD",
                 fixed = T,
                 random = F,
                 method.tau = "REML",
                 hakn = TRUE)

summary(meta.sex)

forest_sex.prim = forest(meta.sex,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = F, common = F, 
       leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient[95% CI] "),
       rightcols = c("w.fixed"), xlim = c(-2,2),smlab = "")

tiff(filename = "C:/Users/herongw/Desktop/Kelly_RA/Projects/depressive_DNAm_HRS/forest_sex_prim.tif", res = 500, height = 1500, width = 4500)
forest(meta.sex,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = T, 
       leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient for high depressive 
            symptoms (CES-D>=4)[95% CI] "),
       rightcols = c("w.fixed"), xlim = c(-2,2),smlab = "Mean difference in 
GrimAge acceleration")
dev.off()
```

## strata forest plot ##
```{r}
beta_strata <- tibble::tibble(Strata  = c("Male", "Female", "NH-Hispanic White",
                                      "NH-Hispanic Black or Other","Hispanic","NH-Hispanic White Male", 
                                      "NH-Hispanic White Female", "NH-Hispanic Black or Other Male", 
                                      "NH-Hispanic Black or Other Female", "Hispanic Male", "Hispanic Female"),
                          primary.beta = c(1.81, 0.85, 1.33, 0.74, 1.14, 1.93, 1.05, 1.13, 0.55, 1.88,
                                           0.76),
                          primary.low  = c(1.11, 0.39, 0.83, -0.10, 0.35, 0.98, 0.46, -0.43, -0.47, 0.48, -0.21),
                          primary.up = c(2.51, 1.31, 1.84, 1.59, 1.93, 2.87, 1.64, 2.70, 1.57, 3.29, 1.72),
                          full.beta = c(0.84, 0.18, 0.35, 0.29, 0.74, 0.78, 0.17, 0.66, 0.13, 1.41, 0.36),
                          full.low = c(0.22, -0.21, -0.10, -0.44, 0.02, -0.05, -0.34, -0.68, -0.75, 0.18, -0.52),
                          full.up = c(1.46, 1.58, 0.79, 1.02, 1.45, 1.61, 0.67, 2.01, 1.01, 2.64, 1.24))

### Step 2: Make forest plot
ggplot(beta_strata, aes(x=Strata, y=primary.beta, ymin=primary.low, ymax=primary.up)) + 
  #specify position here
  geom_linerange(size=1,position=position_dodge(width = 0.5)) +
  geom_hline(yintercept=0, lty=2) +
  #specify position here too
  geom_point(size=1, shape=21, colour="black", stroke = 0.5,position=position_dodge(width = 0.5)) +
  scale_x_discrete(name="Strata") +
  scale_y_continuous(name="Coefficient", limits = c(-0.8, 3.3)) +
  theme(axis.text.x=element_text(size=30))+
  coord_flip() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## clocks acceleration correlation matrix
```{r}
cor.m = complete_bo %>% 
  dplyr::select(GRIM_residuals, LEVINE_residuals, MPOA_residuals, HORVATH_residuals, HANNUM_residuals)
colnames(cor.m) = c("GrimAge", "Levine", "MPOA", "Horvath", "Hannum")

cor = cor(cor.m)

cor.test(complete_bo$GRIM_residuals, complete_bo$LEVINE_residuals)

library("PerformanceAnalytics")
chart.Correlation(cor.m, histogram=F, pch=29)

install.packages("psych")
library(psych)

pairs.panels(cor.m,
             smooth = F,      # If TRUE, draws loess smooths
             scale = FALSE,      # If TRUE, scales the correlation text font
             density = F,     # If TRUE, adds density plots and histograms
             ellipses = F,    # If TRUE, draws ellipses
             method = "pearson", # Correlation method (also "spearman" or "kendall")
             pch = 21,           # pch symbol
             lm = T,         # If TRUE, plots linear fit rather than the LOESS (smoothed) fit
             cor = TRUE,         # If TRUE, reports correlations
             jiggle = FALSE,     # If TRUE, data points are jittered
             factor = 2,         # Jittering factor
             hist.col = 0,       # Histograms color
             stars = TRUE,       # If TRUE, adds significance level with stars
             ci = TRUE,
             cex.cor = 4,
             rug = F)          # If TRUE, adds confidence intervals

```

## plot of clocks against age acceleration
```{r}
complete_bo %>% 
  ggplot(aes(x = age, y = DNAMGRIMAGE, group = depression)) +
  geom_jitter(aes(shape = depression, color = depression), alpha = 0.8, size = 2)+
  geom_smooth(aes(linetype = depression), color = "black", method = "lm", size = 1.5, se = F) + 
  labs(y = "GrimAge (years)", x = "Chronological age (years)")+
  scale_shape_manual(values = c(16, 17)) +
  scale_color_manual(values = c('#999999','#E69F00'))+
  theme_minimal()+
  theme(legend.key.height= unit(0.8, 'cm'),
        legend.key.width= unit(1.2, 'cm'))+
  guides(colour = guide_legend(override.aes = list(size=5)))
  
  
```

## sex and race models and forest plot
```{r}

################## Health behavior models #####################

white_male = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = subset(complete_bo, GENDER == "Male" & race_ethnicity == "Non-Hispanic White" ))
summary(white_male)
confint(white_male)

white_female = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = subset(complete_bo, GENDER == "Female" & race_ethnicity == "Non-Hispanic White" ))
summary(white_female)
confint(white_female)

black_male = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = subset(complete_bo, GENDER == "Male" & race_ethnicity == "NH-Black or Other" ))
summary(black_male)
confint(black_male)

black_female = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = subset(complete_bo, GENDER == "Female" & race_ethnicity == "NH-Black or Other" ))
summary(black_female)
confint(black_female)

#other_male = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = subset(complete, GENDER == "Male" & race_ethnicity == "Non-Hispanic Other" ))
#summary(other_male)
#confint(other_male)

#other_female = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = subset(complete, GENDER == "Female" & race_ethnicity == "Non-Hispanic Other" ))
#summary(other_female)
#confint(other_female)

hispanic_male = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = subset(complete_bo, GENDER == "Male" & race_ethnicity == "Hispanic" ))
summary(hispanic_male)
confint(hispanic_male)

hispanic_female = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO  , data = subset(complete_bo, GENDER == "Female" & race_ethnicity == "Hispanic" ))
summary(hispanic_female)
confint(hispanic_female)


### forest plot ###
#### do not use metacont() here
######## metacont() is used in raw data instead of pre-calculated effect size
##################### for pre-calculated effect size, we can use metagen()
group = "Non-Hispanic White Male"
effect.size = white_male$coefficients[2]
effect.size.se <- summary(white_male)$coefficients[2,2]
white.male <- data.frame(group, effect.size, effect.size.se)
colnames(white.male) = c('group', "effect.size", "effect.size.sd")

group = "Non-Hispanic White Female"
effect.size = white_female$coefficients[2]
effect.size.se <- summary(white_female)$coefficients[2,2]
white.female <- data.frame(group, effect.size, effect.size.se)
colnames(white.female) = c('group', "effect.size", "effect.size.sd")

group = "Non-Hispanic Black or Other Male"
effect.size = black_male$coefficients[2]
effect.size.se <- summary(black_male)$coefficients[2,2]
black.male <- data.frame(group, effect.size, effect.size.se)
colnames(black.male) = c('group', "effect.size", "effect.size.sd")

group = "Non-Hispanic Black or Other Female"
effect.size = black_female$coefficients[2]
effect.size.se <- summary(black_female)$coefficients[2,2]
black.female <- data.frame(group, effect.size, effect.size.se)
colnames(black.female) = c('group', "effect.size", "effect.size.sd")

#group = "other male"
#effect.size = other_male$coefficients[2]
#effect.size.se <- summary(other_male)$coefficients[2,2]
#other.male <- data.frame(group, effect.size, effect.size.se)
#colnames(other.male) = c('group', "effect.size", "effect.size.sd")

#group = "other female"
#effect.size = other_female$coefficients[2]
#effect.size.se <- summary(other_female)$coefficients[2,2]
#other.female <- data.frame(group, effect.size, effect.size.se)
#colnames(other.female) = c('group', "effect.size", "effect.size.sd")

group = "Hispanic Male"
effect.size = hispanic_male$coefficients[2]
effect.size.se <- summary(hispanic_male)$coefficients[2,2]
hispanic.male <- data.frame(group, effect.size, effect.size.se)
colnames(hispanic.male) = c('group', "effect.size", "effect.size.sd")

group = "Hispanic Female"
effect.size = hispanic_female$coefficients[2]
effect.size.se <- summary(hispanic_female)$coefficients[2,2]
hispanic.female <- data.frame(group, effect.size, effect.size.se)
colnames(hispanic.female) = c('group', "effect.size", "effect.size.sd")

meta_sex_race <- rbind(white.male, white.female, black.male, black.female,
                        hispanic.male, hispanic.female)
rownames(meta_sex_race) <- c("1", "2","3", "4", "5", "6")

meta.sex.race <- metagen(TE = effect.size,
                 seTE = effect.size.sd,
                 studlab = group,
                 data = meta_sex_race,
                 sm = "MD",
                 fixed = T,
                 random = F,
                 method.tau = "REML",
                 hakn = TRUE)

summary(meta.sex.race)

forest_sex_race.hlth = forest(meta.sex.race,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = F, 
                              common = F, leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient [95% CI] "),
       rightcols = c("w.fixed"), xlim = c(-2,2),smlab = "")

tiff(filename = "C:/Users/herongw/Desktop/Kelly_RA/Projects/depressive_DNAm_HRS/forest_sex_race_hlth.tif", res = 500, height = 2000, width = 6000)
forest(meta.sex.race,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = T, 
       leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient for high depressive 
            symptoms (CES-D>=4)[95% CI] "),
       rightcols = c("w.fixed"), xlim = c(-2,2),smlab = "Mean difference in 
GrimAge acceleration")
dev.off()

################### Primary models #####################

white_male = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = subset(complete_bo, GENDER == "Male" & race_ethnicity == "Non-Hispanic White" ))
summary(white_male)
confint(white_male)

white_female = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = subset(complete_bo, GENDER == "Female" & race_ethnicity == "Non-Hispanic White" ))
summary(white_female)
confint(white_female)

black_male = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = subset(complete_bo, GENDER == "Male" & race_ethnicity == "NH-Black or Other" ))
summary(black_male)
confint(black_male)

black_female = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = subset(complete_bo, GENDER == "Female" & race_ethnicity == "NH-Black or Other" ))
summary(black_female)
confint(black_female)

#other_male = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = subset(complete, GENDER == "Male" & race_ethnicity == "Non-Hispanic Other" ))
#summary(other_male)
#confint(other_male)

#other_female = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = subset(complete, GENDER #== "Female" & race_ethnicity == "Non-Hispanic Other" ))
#summary(other_female)
#confint(other_female)

hispanic_male = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = subset(complete_bo, GENDER == "Male" & race_ethnicity == "Hispanic" ))
summary(hispanic_male)
confint(hispanic_male)

hispanic_female = lm(GRIM_residuals ~ depression + age  +  DEGREE_collapsed + PMARST_collapsed +  gran + PMONO  , data = subset(complete_bo, GENDER == "Female" & race_ethnicity == "Hispanic" ))
summary(hispanic_female)
confint(hispanic_female)


### forest plot ###
#### do not use metacont() here
######## metacont() is used in raw data instead of pre-calculated effect size
##################### for pre-calculated effect size, we can use metagen()
group = "Non-Hispanic White Male"
effect.size = white_male$coefficients[2]
effect.size.se <- summary(white_male)$coefficients[2,2]
white.male <- data.frame(group, effect.size, effect.size.se)
colnames(white.male) = c('group', "effect.size", "effect.size.sd")

group = "Non-Hispanic White Female"
effect.size = white_female$coefficients[2]
effect.size.se <- summary(white_female)$coefficients[2,2]
white.female <- data.frame(group, effect.size, effect.size.se)
colnames(white.female) = c('group', "effect.size", "effect.size.sd")

group = "Non-Hispanic Black or Other Male"
effect.size = black_male$coefficients[2]
effect.size.se <- summary(black_male)$coefficients[2,2]
black.male <- data.frame(group, effect.size, effect.size.se)
colnames(black.male) = c('group', "effect.size", "effect.size.sd")

group = "Non-Hispanic Black or Other Female"
effect.size = black_female$coefficients[2]
effect.size.se <- summary(black_female)$coefficients[2,2]
black.female <- data.frame(group, effect.size, effect.size.se)
colnames(black.female) = c('group', "effect.size", "effect.size.sd")

#group = "other male"
#effect.size = other_male$coefficients[2]
#effect.size.se <- summary(other_male)$coefficients[2,2]
#other.male <- data.frame(group, effect.size, effect.size.se)
#colnames(other.male) = c('group', "effect.size", "effect.size.sd")

#group = "other female"
#effect.size = other_female$coefficients[2]
#effect.size.se <- summary(other_female)$coefficients[2,2]
#other.female <- data.frame(group, effect.size, effect.size.se)
#colnames(other.female) = c('group', "effect.size", "effect.size.sd")

group = "Hispanic Male"
effect.size = hispanic_male$coefficients[2]
effect.size.se <- summary(hispanic_male)$coefficients[2,2]
hispanic.male <- data.frame(group, effect.size, effect.size.se)
colnames(hispanic.male) = c('group', "effect.size", "effect.size.sd")

group = "Hispanic Female"
effect.size = hispanic_female$coefficients[2]
effect.size.se <- summary(hispanic_female)$coefficients[2,2]
hispanic.female <- data.frame(group, effect.size, effect.size.se)
colnames(hispanic.female) = c('group', "effect.size", "effect.size.sd")

meta_sex_race <- rbind(white.male, white.female, black.male, black.female,
                        hispanic.male, hispanic.female)
rownames(meta_sex_race) <- c("1", "2","3", "4", "5", "6")

meta.sex.race <- metagen(TE = effect.size,
                 seTE = effect.size.sd,
                 studlab = group,
                 data = meta_sex_race,
                 sm = "MD",
                 fixed = T,
                 random = F,
                 method.tau = "REML",
                 hakn = TRUE)

summary(meta.sex.race)

forest_sex_race.prim = forest(meta.sex.race,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = F, 
       common = F, leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient [95% CI] "),
       rightcols = c("w.fixed"), xlim = c(-2,2),smlab = "")

tiff(filename = "C:/Users/herongw/Desktop/Kelly_RA/Projects/depressive_DNAm_HRS/forest_sex_race_prim.tif", res = 500, height = 2000, width = 6000)
forest(meta.sex.race,print.I2 = F, print.I2.ci = F, print.tau2 = F, print.pval.Q = T, 
       leftcols = c("studlab", "effect.ci"), leftlabs = c("Strata","Coefficient for high depressive 
            symptoms (CES-D>=4)[95% CI] "),
       rightcols = c("w.fixed"), xlim = c(-2,2),smlab = "Mean difference in 
GrimAge acceleration")
dev.off()


################### unadjusted model #####################
white_male = lm(GRIM_residuals ~ depression, data = subset(complete_bo, GENDER == "Male" & race_ethnicity == "Non-Hispanic White" ))
summary(white_male)
confint(white_male)

white_female = lm(GRIM_residuals ~ depression, data = subset(complete_bo, GENDER == "Female" & race_ethnicity == "Non-Hispanic White" ))
summary(white_female)
confint(white_female)

black_male = lm(GRIM_residuals ~ depression, data = subset(complete_bo, GENDER == "Male" & race_ethnicity == "NH-Black or Other" ))
summary(black_male)
confint(black_male)

black_female = lm(GRIM_residuals ~ depression, data = subset(complete_bo, GENDER == "Female" & race_ethnicity == "NH-Black or Other" ))
summary(black_female)
confint(black_female)

#other_male = lm(GRIM_residuals ~ depression, data = subset(complete, GENDER == "Male" & race_ethnicity == "Non-Hispanic Other" ))
#summary(other_male)
#confint(other_male)

#other_female = lm(GRIM_residuals ~ depression, data = subset(complete, GENDER == "Female" & race_ethnicity == "Non-Hispanic Other" ))
#summary(other_female)
#confint(other_female)

hispanic_male = lm(GRIM_residuals ~ depression, data = subset(complete_bo, GENDER == "Male" & race_ethnicity == "Hispanic" ))
summary(hispanic_male)
confint(hispanic_male)

hispanic_female = lm(GRIM_residuals ~ depression, data = subset(complete, GENDER == "Female" & race_ethnicity == "Hispanic" ))
summary(hispanic_female)
confint(hispanic_female)
```

## causal mediation analysis -- physical activity

```{r}
# check the interaction between physical activity and depression #
sens_hlth <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + R13ACT  , data = complete)

sens_inter_hlth <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO + R13ACT + R13ACT*depression  , data = complete)

summary(sens_hlth)
summary(sens_inter_hlth)

inter_act_change <- abs((summary(sens_inter_hlth)$coefficient[2,1] - summary(sens_hlth)$coefficient[2,1]))*100/summary(sens_hlth)$coefficient[2,1] ## interaction change beta 3%

# causal mediation analysis

complete2 <- complete %>% 
  mutate(high_depression = if_else(depression == "Elevated depressive symptoms", 1,0))

set.seed(2022)


med.fit <- lm(R13ACT ~ high_depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete2)
summary(med.fit)
out.fit <- lm(GRIM_residuals ~ high_depression + R13ACT + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete2)
summary(out.fit)

med.out <- mediate(med.fit, out.fit, treat = "high_depression", mediator = "R13ACT", boot = T,  sims = 1000)
summary(med.out)

## sensitivity analysis ##
sens.out <- medsens(med.out, rho.by = 0.1, effect.type = "both", sims = 100)
summary(sens.out)


### use CMAvers ##
set.seed(2022)
med_act <- cmest(data = complete, model = "rb", outcome = "GRIM_residuals", exposure = "depression",
                                mediator = "R13ACT", basec = c("age" , "GENDER" , "race_ethnicity" , "DEGREE_collapsed" , "PMARST_collapsed" , "R13CONDE" , "R13DRINKD" , "gran" , "PMONO", "smoke"), EMint = TRUE,
                                mreg = list("linear"), yreg = "linear",
                                astar = "Low or no depressive symptoms", a = "Elevated depressive symptoms", mval = list(0), 
                                estimation = "paramfunc", inference = "bootstrap", nboot = 1000)

summary(med_act)
```

## causal mediation -- smoking

```{r}
# use CMAverse #
set.seed(2022)
med_smk <- cmest(data = complete, model = "rb", outcome = "GRIM_residuals", exposure = "depression",
                                mediator = "smoke", basec = c("age" , "GENDER" , "race_ethnicity" , "DEGREE_collapsed" , "PMARST_collapsed" , "R13CONDE" , "R13DRINKD" , "gran" , "PMONO"), EMint = TRUE,
                                mreg = list("multinomial"), yreg = "linear",
                                astar = "Low or no depressive symptoms", a = "Elevated depressive symptoms", mval = list("Never"), 
                                estimation = "paramfunc", inference = "bootstrap", nboot = 1000)

summary(med_smk)
```

## causal mediation -- physical activity + smoking

```{r}
set.seed(2022)
med_smk_act <- cmest(data = complete, model = "rb", outcome = "GRIM_residuals", exposure = "depression",
                                mediator = c("smoke", "R13ACT"), basec = c("age" , "GENDER" , "race_ethnicity" , "DEGREE_collapsed" , "PMARST_collapsed" , "R13CONDE" , "R13DRINKD" , "gran" , "PMONO"), EMint = TRUE,
                                mreg = list("multinomial", "linear"), yreg = "linear",
                                astar = "Low or no depressive symptoms", a = "Elevated depressive symptoms", mval = list("Never", 0), 
                                estimation = "imputation", inference = "bootstrap", nboot = 1000)

summary(med_smk_act)
```

## multi-panel histogram of age acceleration + depression symptoms

```{r}
par(mfrow = c(3,3))
hist(complete$GRIM_residuals, xlab = "Age acceleration (Years)", main = "Histgram of GrimAge acceleration")
hist(complete$HORVATH_residuals, xlab = "Age acceleration (Years)", main = "Histgram of Horvath acceleration")
hist(complete$LEVINE_residuals, xlab = "Age acceleration (Years)", main = "Histgram of Levine acceleration")
hist(complete$MPOA_residuals, xlab = "Age acceleration (Years)", main = "Histgram of MPOA acceleration")
hist(complete$HANNUM_residuals, xlab = "Age acceleration (Years)", main = "Histgram of Hannum acceleration")
hist(complete$R13CESD, xlab = "CES-D score", main = "Histgram of CES-D score")

```

# sensitivity analysis -- excluded people older than 85 ##
```{r}
complete_85 <- complete_bo %>% 
  dplyr::filter(age <= 85)

model_crude <- lm(GRIM_residuals ~ depression, data = complete_85)

plot(model_crude)
summary(model_crude)
confint(model_crude)

model_prim <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = complete_85)

plot(model_prim)
summary(model_prim)
confint(model_prim)

model_hlth <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete_85)

plot(model_hlth)
summary(model_hlth)
confint(model_hlth)


model_crude <- lm(GRIM_residuals ~ R13CESD, data = complete_85)

plot(model_crude)
summary(model_crude)
confint(model_crude)

model_prim <- lm(GRIM_residuals ~ R13CESD + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO  , data = complete_85)

plot(model_prim)
summary(model_prim)
confint(model_prim)

model_hlth <- lm(GRIM_residuals ~ R13CESD + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete_85)

plot(model_hlth)
summary(model_hlth)
confint(model_hlth)
```


# calculate the partial R square ###
```{r}

### GrimAge ###
model_hlth <- lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete_bo)

model_behavior = lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO , data = complete_bo)

model_age.sex.race = lm(GRIM_residuals ~ depression + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete_bo)

model_edu.marri = lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete_bo)

model_cell = lm(GRIM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke , data = complete_bo)

model_depressive = lm(GRIM_residuals ~  age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO , data = complete_bo)

### partial R2 ###
grim.behavior = (sum(resid(model_behavior)^2) - sum(resid(model_hlth)^2))/(sum(resid(model_behavior)^2))
grim.age.sex.race = (sum(resid(model_age.sex.race)^2) -
                       sum(resid(model_hlth)^2))/(sum(resid(model_age.sex.race)^2))
grim.edu.marri = (sum(resid(model_edu.marri)^2) -
                       sum(resid(model_hlth)^2))/(sum(resid(model_edu.marri)^2))
grim.cell = (sum(resid(model_cell)^2) -
                       sum(resid(model_hlth)^2))/(sum(resid(model_cell)^2))
grim.depressive = (sum(resid(model_depressive)^2) -
                       sum(resid(model_hlth)^2))/(sum(resid(model_depressive)^2))

GrimAge = c(grim.age.sex.race, grim.edu.marri, grim.cell, grim.behavior, grim.depressive)

## Horvath ##
model_horvath <- lm(HORVATH_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_horvath.behavior = lm(HORVATH_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO, data = complete_bo)

model_horvath.age.sex.race = lm(HORVATH_residuals ~ depression + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_horvath.edu.marri = lm(HORVATH_residuals ~ depression + age + GENDER + race_ethnicity + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_horvath.cell = lm(HORVATH_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke , data = complete_bo)

model_horvath.depressive = lm(HORVATH_residuals ~ age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

### partial R2 ###
horvath.behavior = (sum(resid(model_horvath.behavior)^2) -
                   sum(resid(model_horvath)^2))/(sum(resid(model_horvath.behavior)^2))
horvath.age.sex.race = (sum(resid(model_horvath.age.sex.race)^2) -
                   sum(resid(model_horvath)^2))/(sum(resid(model_horvath.age.sex.race)^2))
horvath.edu.marri = (sum(resid(model_horvath.edu.marri)^2) -
                   sum(resid(model_horvath)^2))/(sum(resid(model_horvath.edu.marri)^2))
horvath.cell = (sum(resid(model_horvath.cell)^2) -
                   sum(resid(model_horvath)^2))/(sum(resid(model_horvath.cell)^2))
horvath.depressive = (sum(resid(model_horvath.depressive)^2) -
                   sum(resid(model_horvath)^2))/(sum(resid(model_horvath.depressive)^2))

Horvath = c(horvath.age.sex.race, horvath.edu.marri, horvath.cell, horvath.behavior,
            horvath.depressive)

## Hannum ###
model_hannum <- lm(HANNUM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_hannum.behavior = lm(HANNUM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO, data = complete_bo)

model_hannum.age.sex.race = lm(HANNUM_residuals ~ depression + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_hannum.edu.marri = lm(HANNUM_residuals ~ depression + age + GENDER + race_ethnicity + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_hannum.cell = lm(HANNUM_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke , data = complete_bo)

model_hannum.depressive = lm(HANNUM_residuals ~ age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

### partial R2 ###
hannum.behavior = (sum(resid(model_hannum.behavior)^2) -
                   sum(resid(model_hannum)^2))/(sum(resid(model_hannum.behavior)^2))
hannum.age.sex.race = (sum(resid(model_hannum.age.sex.race)^2) -
                   sum(resid(model_hannum)^2))/(sum(resid(model_hannum.age.sex.race)^2))
hannum.edu.marri = (sum(resid(model_hannum.edu.marri)^2) -
                   sum(resid(model_hannum)^2))/(sum(resid(model_hannum.edu.marri)^2))
hannum.cell = (sum(resid(model_hannum.cell)^2) -
                   sum(resid(model_hannum)^2))/(sum(resid(model_hannum.cell)^2))
hannum.depressive = (sum(resid(model_hannum.depressive)^2) -
                   sum(resid(model_hannum)^2))/(sum(resid(model_hannum.depressive)^2))

Hannum = c(hannum.age.sex.race, hannum.edu.marri, hannum.cell, hannum.behavior,
            hannum.depressive)

## Levine ##
model_levine <- lm(LEVINE_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_levine.behavior = lm(LEVINE_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO, data = complete_bo)

model_levine.age.sex.race = lm(LEVINE_residuals ~ depression + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_levine.edu.marri = lm(LEVINE_residuals ~ depression + age + GENDER + race_ethnicity + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_levine.cell = lm(LEVINE_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke , data = complete_bo)

model_levine.depressive = lm(LEVINE_residuals ~ age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

### partial R2 ###
levine.behavior = (sum(resid(model_levine.behavior)^2) -
                   sum(resid(model_levine)^2))/(sum(resid(model_levine.behavior)^2))
levine.age.sex.race = (sum(resid(model_levine.age.sex.race)^2) -
                   sum(resid(model_levine)^2))/(sum(resid(model_levine.age.sex.race)^2))
levine.edu.marri = (sum(resid(model_levine.edu.marri)^2) -
                   sum(resid(model_levine)^2))/(sum(resid(model_levine.edu.marri)^2))
levine.cell = (sum(resid(model_levine.cell)^2) -
                   sum(resid(model_levine)^2))/(sum(resid(model_levine.cell)^2))
levine.depressive = (sum(resid(model_levine.depressive)^2) -
                   sum(resid(model_levine)^2))/(sum(resid(model_levine.depressive)^2))

Levine = c(levine.age.sex.race, levine.edu.marri, levine.cell, levine.behavior,
            levine.depressive)

## MPOA ##
model_MPOA <- lm(MPOA_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_MPOA.behavior = lm(MPOA_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + gran + PMONO, data = complete_bo)

model_MPOA.age.sex.race = lm(MPOA_residuals ~ depression + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_MPOA.edu.marri = lm(MPOA_residuals ~ depression + age + GENDER + race_ethnicity + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

model_MPOA.cell = lm(MPOA_residuals ~ depression + age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke , data = complete_bo)

model_MPOA.depressive = lm(MPOA_residuals ~ age + GENDER + race_ethnicity + DEGREE_collapsed + PMARST_collapsed + R13CONDE + R13DRINKD + smoke + gran + PMONO, data = complete_bo)

### partial R2 ###
MPOA.behavior = (sum(resid(model_MPOA.behavior)^2) -
                   sum(resid(model_MPOA)^2))/(sum(resid(model_MPOA.behavior)^2))
MPOA.age.sex.race = (sum(resid(model_MPOA.age.sex.race)^2) -
                   sum(resid(model_MPOA)^2))/(sum(resid(model_MPOA.age.sex.race)^2))
MPOA.edu.marri = (sum(resid(model_MPOA.edu.marri)^2) -
                   sum(resid(model_MPOA)^2))/(sum(resid(model_MPOA.edu.marri)^2))
MPOA.cell = (sum(resid(model_MPOA.cell)^2) -
                   sum(resid(model_MPOA)^2))/(sum(resid(model_MPOA.cell)^2))
MPOA.depressive = (sum(resid(model_MPOA.depressive)^2) -
                   sum(resid(model_MPOA)^2))/(sum(resid(model_MPOA.depressive)^2))

MPOA = c(MPOA.age.sex.race, MPOA.edu.marri, MPOA.cell, MPOA.behavior,
            MPOA.depressive)


############### stack barplot ###################
R2 = data.frame(rbind(GrimAge, Horvath, Hannum, Levine, MPOA))
R2 = R2 %>% 
  rename(age.sex.race=X1,education.marital=X2, cell.type=X3, hehavior=X4, depressive=X5) %>% 
  mutate(clock = rownames(.))

R2 = R2 %>% 
  gather("covariates", "R2", -clock) %>% 
  mutate(covariates = case_when(covariates == "age.sex.race" ~ "Age, Sex, Race/ethnicity",
                                covariates == "cell.type" ~ "Cell type composition",
                                covariates == "depressive" ~ "Depressive symptoms",
                                covariates == "education.marital" ~ "Education and Marital status",
                                covariates == "hehavior" ~ "Health behaviors"))

bar_R2 = R2 %>%  ggplot(aes(fill=covariates, y=R2, x=clock)) + 
    geom_bar(position="stack", stat="identity")+
    scale_fill_viridis(discrete = T) +
    labs(y = bquote("Partial"~R^2), x = "Epigenetic clocks")+
    #geom_text(size = 3, position = position_stack(vjust = 0.5))
    theme(axis.text.y = element_text(angle=90, vjust=.5, hjust=1))
    


png(filename = "partial_R2_bar.png", width = 800, height = 400)
bar_R2
dev.off()
    
```

